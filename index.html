<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoSort - ìŠ¤ë§ˆíŠ¸ ë¶„ë¦¬ìˆ˜ê±°</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f8f9fa; 
            min-height: 100vh; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            padding: 20px; 
        }
        .container { 
            background: white; 
            border-radius: 24px; 
            padding: 50px; 
            max-width: 800px; 
            width: 100%; 
            box-shadow: 0 8px 30px rgba(0,0,0,0.12); 
            border: 1px solid #e9ecef;
        }
        h1 { 
            color: #1a202c; 
            margin-bottom: 40px; 
            text-align: center; 
            font-size: 2.8em; 
            font-weight: 800;
            letter-spacing: -1px;
        }
        h1 .subtitle {
            display: block;
            font-size: 0.4em;
            color: #718096;
            font-weight: 600;
            margin-top: 8px;
            letter-spacing: 0;
        }
        
        /* ë¡œê·¸ì¸ í™”ë©´ */
        #loginScreen { text-align: center; padding: 40px 0; }
        #loginScreen p { 
            margin-bottom: 40px; 
            color: #718096; 
            font-size: 1.2em; 
            line-height: 1.6; 
        }
        .login-btn { 
            background: white; 
            color: #1a202c; 
            border: 3px solid #e2e8f0; 
            padding: 20px 50px; 
            border-radius: 16px; 
            font-size: 1.1em; 
            cursor: pointer; 
            width: 100%; 
            max-width: 400px;
            margin: 0 auto;
            font-weight: 700; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 12px; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 14px rgba(0,0,0,0.1);
        }
        .login-btn:hover { 
            border-color: #06b6d4; 
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(6, 182, 212, 0.3);
        }
        
        /* ì‚¬ìš©ì ì •ë³´ */
        .user-info { 
            display: flex; 
            align-items: center; 
            gap: 15px;
            margin-bottom: 30px; 
            padding: 20px 25px; 
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            border-radius: 16px; 
            border: 2px solid #e2e8f0;
        }
        .user-info img { 
            width: 50px; 
            height: 50px; 
            border-radius: 50%; 
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }
        .user-name { 
            flex: 1; 
            font-weight: 700; 
            color: #1a202c; 
            font-size: 1.1em;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .logout-btn { 
            background: #b91c1c; 
            color: white; 
            border: none; 
            padding: 0; 
            border-radius: 50%; 
            cursor: pointer; 
            font-size: 1.2em; 
            transition: all 0.2s;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            box-shadow: 0 3px 10px rgba(185, 28, 28, 0.3);
        }
        .logout-btn:hover {
            background: #991b1b;
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(185, 28, 28, 0.5);
        }
        
        /* íƒ­ ë©”ë‰´ */
        .tabs { 
            display: flex; 
            gap: 15px; 
            margin-bottom: 35px; 
            background: #f7fafc;
            padding: 8px;
            border-radius: 16px;
        }
        .tab { 
            flex: 1; 
            padding: 16px; 
            background: transparent; 
            border: none; 
            border-radius: 12px; 
            cursor: pointer; 
            font-weight: 700; 
            font-size: 1.05em;
            transition: all 0.3s;
            color: #718096;
        }
        .tab.active { 
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); 
            color: white; 
            box-shadow: 0 4px 12px rgba(6, 182, 212, 0.25);
        }
        
        .upload-area { 
            border: 4px dashed #cbd5e0; 
            border-radius: 20px; 
            padding: 60px 30px; 
            text-align: center; 
            cursor: pointer; 
            transition: all 0.3s; 
            margin-bottom: 25px; 
            background: #f7fafc;
        }
        .upload-area:hover { 
            border-color: #06b6d4; 
            background: linear-gradient(135deg, #f0fdfa 0%, #e0f2fe 100%);
            transform: translateY(-2px);
        }
        .upload-area.drag-over { 
            border-color: #06b6d4; 
            background: linear-gradient(135deg, #cffafe 0%, #bae6fd 100%);
            border-style: solid;
        }
        .upload-area p {
            font-size: 1.3em;
            color: #4a5568;
            font-weight: 600;
            margin: 0;
        }
        input[type="file"] { display: none; }
        button { 
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); 
            color: white; 
            border: none; 
            padding: 20px 50px; 
            border-radius: 16px; 
            font-size: 1.15em; 
            cursor: pointer; 
            width: 100%; 
            margin-top: 15px; 
            font-weight: 700; 
            transition: all 0.3s;
            box-shadow: 0 6px 20px rgba(6, 182, 212, 0.25);
        }
        button:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 10px 30px rgba(6, 182, 212, 0.35);
        }
        button:disabled { 
            opacity: 0.5; 
            cursor: not-allowed; 
            transform: none;
            box-shadow: none;
        }
        #preview { 
            max-width: 100%; 
            max-height: 500px;
            width: auto;
            height: auto;
            border-radius: 16px; 
            margin: 25px auto; 
            display: none; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            object-fit: contain;
        }
        #result { 
            margin-top: 35px; 
            padding: 35px; 
            background: white;
            border-radius: 20px; 
            display: none; 
            border: 2px solid #e5e7eb;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
        }
        .result-label { 
            font-size: 2.2em; 
            color: #1f2937; 
            font-weight: 800; 
            margin-bottom: 15px; 
            text-align: center;
        }
        .result-score { 
            color: #2d3748; 
            font-size: 1.4em; 
            font-weight: 600;
            text-align: center;
        }
        .disposal-info {
            margin-top: 20px;
            padding: 20px;
            background: #f9fafb;
            border-radius: 12px;
            font-size: 1.1em;
            color: #374151;
            line-height: 1.6;
            border-left: 5px solid #06b6d4;
        }
        .spinner { 
            border: 5px solid #e2e8f0; 
            border-top: 5px solid #667eea; 
            border-radius: 50%; 
            width: 60px; 
            height: 60px; 
            animation: spin 0.8s linear infinite; 
            margin: 30px auto; 
            display: none; 
        }
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        .error { 
            background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%);
            color: #742a2a; 
            padding: 20px; 
            border-radius: 16px; 
            margin-top: 25px; 
            display: none; 
            font-weight: 600;
            border: 3px solid #fc8181;
            font-size: 1.05em;
        }
        
        /* íˆìŠ¤í† ë¦¬ */
        #historyTab { display: none; }
        .history-item { 
            background: linear-gradient(135deg, #ffffff 0%, #f7fafc 100%);
            padding: 25px; 
            border-radius: 16px; 
            margin-bottom: 20px; 
            display: flex; 
            gap: 20px; 
            align-items: center; 
            border: 2px solid #e2e8f0;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .history-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.1);
            border-color: #cbd5e0;
        }
        .history-img { 
            width: 100px; 
            height: 100px; 
            object-fit: cover; 
            border-radius: 12px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .history-info { flex: 1; }
        .history-label { 
            font-weight: 800; 
            color: #0891b2; 
            font-size: 1.4em; 
            margin-bottom: 8px;
        }
        .history-score {
            color: #4a5568;
            font-size: 1.05em;
            font-weight: 600;
            margin-bottom: 8px;
        }
        .history-date { 
            color: #a0aec0; 
            font-size: 0.95em; 
            margin-top: 5px; 
        }
        .no-history { 
            text-align: center; 
            color: #a0aec0; 
            padding: 60px 20px; 
            font-size: 1.2em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>â™»ï¸ EcoSort<span class="subtitle">AI ìŠ¤ë§ˆíŠ¸ ë¶„ë¦¬ìˆ˜ê±°</span></h1>
        
        <!-- ë¡œê·¸ì¸ í™”ë©´ -->
        <div id="loginScreen">
            <p>ğŸŒ AIê°€ ì“°ë ˆê¸°ë¥¼ ìë™ìœ¼ë¡œ ë¶„ë¥˜í•˜ê³ <br>ì˜¬ë°”ë¥¸ ë¶„ë¦¬ìˆ˜ê±° ë°©ë²•ì„ ì•Œë ¤ë“œë ¤ìš”</p>
            <button class="login-btn" id="googleLoginBtn">
                <svg width="20" height="20" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                Googleë¡œ ë¡œê·¸ì¸
            </button>
        </div>
        
        <!-- ë©”ì¸ í™”ë©´ (ë¡œê·¸ì¸ í›„) -->
        <div id="mainScreen" style="display: none;">
            <!-- ì‚¬ìš©ì ì •ë³´ -->
            <div class="user-info">
                <img id="userPhoto" src="" alt="User">
                <span class="user-name" id="userName"></span>
                <button class="logout-btn" id="logoutBtn" title="ë¡œê·¸ì•„ì›ƒ">ğŸšª</button>
            </div>
            
            <!-- ì—…ë¡œë“œ ì˜ì—­ (í•­ìƒ í‘œì‹œ) -->
            <div class="upload-area" id="uploadArea">
                <p>ğŸ“¸ ì´ë¯¸ì§€ë¥¼ í´ë¦­í•˜ê±°ë‚˜ ë“œë˜ê·¸í•˜ì—¬ ì—…ë¡œë“œ</p>
                <input type="file" id="fileInput" accept="image/*">
            </div>
            
            <img id="preview">
            <div class="spinner" id="spinner"></div>
            
            <div id="result"></div>
            
            <button id="shareBtn" style="display: none; margin-top: 15px; background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);">ğŸ“¤ ê³µìœ í•˜ê¸°</button>
            
            <div class="error" id="error"></div>
            
            <!-- íƒ­ ë©”ë‰´ -->
            <div class="tabs" style="margin-top: 30px;">
                <button class="tab active" id="historyTabBtn">ë‚´ ê¸°ë¡</button>
                <button class="tab" id="statsTabBtn">í†µê³„</button>
            </div>
            
            <!-- íˆìŠ¤í† ë¦¬ íƒ­ -->
            <div id="historyTab">
                <div id="historyList"></div>
            </div>
            
            <!-- í†µê³„ íƒ­ -->
            <div id="statsTab" style="display: none;">
                <div id="statsContent"></div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, query, where, orderBy, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

        // Firebase ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyAntkuWODPMzCr6pBK6HInee9Vrd_Dvdc0",
            authDomain: "garbage-classifier-27697.firebaseapp.com",
            projectId: "garbage-classifier-27697",
            storageBucket: "garbage-classifier-27697.firebasestorage.app",
            messagingSenderId: "1079222481108",
            appId: "1:1079222481108:web:f12b06ef3c20eae856cb41"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        const API_URL = 'https://garbage-classifier-16970477973.asia-northeast3.run.app';

        // ë¶„ë¥˜ ë¼ë²¨ í•œê¸€ ë²ˆì—­ ë° ì²˜ë¦¬ ë°©ë²• (ì†Œë¬¸ì í‚¤)
        const wasteInfo = {
            'battery': {
                label: 'ë°°í„°ë¦¬',
                disposal: 'ğŸ”‹ ë°°í„°ë¦¬: ì „ìš© ìˆ˜ê±°í•¨ì— ë°°ì¶œ (ì£¼ë¯¼ì„¼í„°, ëŒ€í˜•ë§ˆíŠ¸)'
            },
            'biological': {
                label: 'ìŒì‹ë¬¼ì“°ë ˆê¸°',
                disposal: 'ğŸ¥¬ ìŒì‹ë¬¼: ë¬¼ê¸° ì œê±° í›„ ì „ìš© ìˆ˜ê±°í•¨ì— ë°°ì¶œ'
            },
            'cardboard': {
                label: 'ê³¨íŒì§€',
                disposal: 'ğŸ“¦ ê³¨íŒì§€: í…Œì´í”„/ìƒí‘œ ì œê±° í›„ í´ì„œ ë°°ì¶œ'
            },
            'clothes': {
                label: 'ì˜ë¥˜',
                disposal: 'ğŸ‘• ì˜ë¥˜: ê¹¨ë—ì´ ì„¸íƒ í›„ ì˜ë¥˜ìˆ˜ê±°í•¨ ë˜ëŠ” ì¬í™œìš©ì„¼í„°'
            },
            'glass': {
                label: 'ìœ ë¦¬',
                disposal: 'ğŸ¾ ìœ ë¦¬ë³‘: ë‚´ìš©ë¬¼ ë¹„ìš°ê³  ëšœê»‘ ë¶„ë¦¬ í›„ ë°°ì¶œ'
            },
            'metal': {
                label: 'ê¸ˆì†',
                disposal: 'ğŸ¥« ìº”ë¥˜: ë‚´ìš©ë¬¼ ì œê±° í›„ ì••ì°©í•˜ì—¬ ë°°ì¶œ'
            },
            'paper': {
                label: 'ì¢…ì´',
                disposal: 'ğŸ“„ ì¢…ì´ë¥˜: ë¹„ë‹/ì² ì‹¬ ì œê±° í›„ ë°°ì¶œ'
            },
            'plastic': {
                label: 'í”Œë¼ìŠ¤í‹±',
                disposal: 'â™»ï¸ í”Œë¼ìŠ¤í‹±: ë¼ë²¨ ì œê±°, ê¹¨ë—ì´ ì”»ì–´ì„œ ë°°ì¶œ'
            },
            'shoes': {
                label: 'ì‹ ë°œ',
                disposal: 'ğŸ‘Ÿ ì‹ ë°œ: ì¬í™œìš©ì„¼í„° ë˜ëŠ” ì˜ë¥˜ìˆ˜ê±°í•¨ì— ë°°ì¶œ'
            },
            'trash': {
                label: 'ì¼ë°˜ì“°ë ˆê¸°',
                disposal: 'ğŸ—‘ï¸ ì¼ë°˜ì“°ë ˆê¸°: ì¢…ëŸ‰ì œë´‰íˆ¬ì— ë°°ì¶œ'
            }
        };

        // DOM ìš”ì†Œ
        const loginScreen = document.getElementById('loginScreen');
        const mainScreen = document.getElementById('mainScreen');
        const googleLoginBtn = document.getElementById('googleLoginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const userName = document.getElementById('userName');
        const userPhoto = document.getElementById('userPhoto');
        
        const historyTabBtn = document.getElementById('historyTabBtn');
        const statsTabBtn = document.getElementById('statsTabBtn');
        const historyTab = document.getElementById('historyTab');
        const statsTab = document.getElementById('statsTab');
        
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const preview = document.getElementById('preview');
        const result = document.getElementById('result');
        const spinner = document.getElementById('spinner');
        const errorDiv = document.getElementById('error');
        const historyList = document.getElementById('historyList');
        const shareBtn = document.getElementById('shareBtn');
        const statsContent = document.getElementById('statsContent');
        
        let classifyBtn = null;
        let selectedFile = null;
        let currentUser = null;

        // ë¡œê·¸ì¸ ìƒíƒœ ê°ì§€
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                userName.textContent = user.displayName;
                userPhoto.src = user.photoURL;
                loginScreen.style.display = 'none';
                mainScreen.style.display = 'block';
                loadHistory();
            } else {
                currentUser = null;
                loginScreen.style.display = 'block';
                mainScreen.style.display = 'none';
            }
        });

        // Google ë¡œê·¸ì¸
        googleLoginBtn.addEventListener('click', async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                alert('ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + error.message);
            }
        });

        // ë¡œê·¸ì•„ì›ƒ
        logoutBtn.addEventListener('click', () => {
            signOut(auth);
        });

        // íƒ­ ì „í™˜
        historyTabBtn.addEventListener('click', () => {
            historyTabBtn.classList.add('active');
            statsTabBtn.classList.remove('active');
            historyTab.style.display = 'block';
            statsTab.style.display = 'none';
            loadHistory();
        });
        
        statsTabBtn.addEventListener('click', () => {
            statsTabBtn.classList.add('active');
            historyTabBtn.classList.remove('active');
            statsTab.style.display = 'block';
            historyTab.style.display = 'none';
            loadStats();
        });

        // íŒŒì¼ ì—…ë¡œë“œ
        uploadArea.addEventListener('click', () => fileInput.click());
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('drag-over');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('drag-over');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                handleFile(file);
            }
        });
        
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) handleFile(file);
        });
        
        function handleFile(file) {
            selectedFile = file;
            const reader = new FileReader();
            reader.onload = (e) => {
                preview.src = e.target.result;
                preview.style.display = 'block';
                
                // ë¶„ë¥˜ ë²„íŠ¼ì´ ì—†ìœ¼ë©´ ìƒì„±
                if (!classifyBtn) {
                    classifyBtn = document.createElement('button');
                    classifyBtn.id = 'classifyBtn';
                    classifyBtn.textContent = 'ğŸ” ë¶„ë¥˜í•˜ê¸°';
                    spinner.parentNode.insertBefore(classifyBtn, spinner.nextSibling);
                    
                    // ë¶„ë¥˜í•˜ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
                    classifyBtn.addEventListener('click', async () => {
                        if (classifyBtn.textContent.includes('ë‹¤ì‹œ')) {
                            // ë‹¤ì‹œ ë¶„ì„í•˜ê¸° ëª¨ë“œ
                            result.style.display = 'none';
                            shareBtn.style.display = 'none';
                            errorDiv.style.display = 'none';
                            classifyBtn.textContent = 'ğŸ” ë¶„ë¥˜í•˜ê¸°';
                        } else {
                            // ë¶„ë¥˜í•˜ê¸° ëª¨ë“œ
                            classifyBtn.disabled = true;
                            await classifyImage();
                            classifyBtn.textContent = 'ğŸ”„ ë‹¤ì‹œ ë¶„ì„í•˜ê¸°';
                            classifyBtn.disabled = false;
                        }
                    });
                } else {
                    classifyBtn.textContent = 'ğŸ” ë¶„ë¥˜í•˜ê¸°';
                    classifyBtn.disabled = false;
                    classifyBtn.style.display = 'block';
                }
                
                result.style.display = 'none';
                errorDiv.style.display = 'none';
                shareBtn.style.display = 'none';
            };
            reader.readAsDataURL(file);
        }
        
        // ê³µìœ í•˜ê¸° ë²„íŠ¼
        let currentResult = null;
        shareBtn.addEventListener('click', async () => {
            if (!currentResult) return;
            
            const shareText = `ğŸ—‘ï¸ ì“°ë ˆê¸° ë¶„ë¥˜ ê²°ê³¼: ${currentResult.label}\nì •í™•ë„: ${(currentResult.score * 100).toFixed(1)}%\n${currentResult.disposal}`;
            
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: 'ì“°ë ˆê¸° ë¶„ë¥˜ ê²°ê³¼',
                        text: shareText
                    });
                } catch (err) {
                    console.log('ê³µìœ  ì·¨ì†Œ:', err);
                }
            } else {
                // í´ë¦½ë³´ë“œ ë³µì‚¬
                navigator.clipboard.writeText(shareText);
                alert('ê²°ê³¼ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
            }
        });
        
        // ë¶„ë¥˜í•˜ê¸° í•¨ìˆ˜
        async function classifyImage() {
            if (!selectedFile || !currentUser) return;
            
            spinner.style.display = 'block';
            result.style.display = 'none';
            errorDiv.style.display = 'none';
            shareBtn.style.display = 'none';
            
            const formData = new FormData();
            formData.append('file', selectedFile);
            
            try {
                const response = await fetch('https://garbage-classifier-16970477973.asia-northeast3.run.app/predict', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                spinner.style.display = 'none';
                
                // API ì‘ë‹µ êµ¬ì¡° í™•ì¸
                if (!data || !data.prediction || !data.prediction.label) {
                    throw new Error('ì˜ëª»ëœ API ì‘ë‹µ í˜•ì‹ì…ë‹ˆë‹¤');
                }
                
                // API labelì„ ì†Œë¬¸ìë¡œ ë³€í™˜
                const labelKey = data.prediction.label.toLowerCase();
                const labelInfo = wasteInfo[labelKey];
                
                if (labelInfo) {
                    result.innerHTML = `
                        <div class="result-box">
                            <h2>ë¶„ë¥˜ ê²°ê³¼</h2>
                            <div class="result-label">${labelInfo.label}</div>
                            <div class="result-score">ì •í™•ë„: ${(data.prediction.score * 100).toFixed(1)}%</div>
                            <div class="result-info">${labelInfo.disposal}</div>
                        </div>
                    `;
                    result.style.display = 'block';
                    shareBtn.style.display = 'block';
                    
                    currentResult = {
                        label: labelInfo.label,
                        score: data.prediction.score,
                        disposal: labelInfo.disposal
                    };
                    
                    // Firestoreì— ì €ì¥
                    await saveToHistory(labelInfo.label, data.prediction.score);
                } else {
                    throw new Error(`ì•Œ ìˆ˜ ì—†ëŠ” ë¶„ë¥˜ ê²°ê³¼: ${data.prediction.label}`);
                }
            } catch (error) {
                spinner.style.display = 'none';
                errorDiv.textContent = 'ë¶„ë¥˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message;
                errorDiv.style.display = 'block';
                console.error('ë¶„ë¥˜ ì˜¤ë¥˜:', error);
            }
        }
        
        // Firestoreì— ì €ì¥
        async function saveToHistory(label, score) {
            try {
                // Firebase Storageì— ì´ë¯¸ì§€ ì—…ë¡œë“œ
                const timestamp = Date.now();
                const imageRef = ref(storage, `images/${currentUser.uid}/${timestamp}_${selectedFile.name}`);
                await uploadBytes(imageRef, selectedFile);
                const imageUrl = await getDownloadURL(imageRef);
                
                // Firestoreì— ë¶„ì„ ê²°ê³¼ ì €ì¥
                await addDoc(collection(db, 'classifications'), {
                    userId: currentUser.uid,
                    userName: currentUser.displayName,
                    imageUrl: imageUrl,
                    label: label,
                    score: score,
                    timestamp: new Date()
                });
            } catch (error) {
                console.error('ì €ì¥ ì˜¤ë¥˜:', error);
            }
        }

        // íˆìŠ¤í† ë¦¬ ë¡œë“œ
        async function loadHistory() {
            if (!currentUser) return;
            
            historyList.innerHTML = '<div class="spinner" style="display: block;"></div>';
            
            try {
                const q = query(
                    collection(db, 'classifications'),
                    where('userId', '==', currentUser.uid),
                    orderBy('timestamp', 'desc')
                );
                
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    historyList.innerHTML = '<div class="no-history">ë¶„ì„ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                    return;
                }
                
                historyList.innerHTML = '';
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const item = document.createElement('div');
                    item.className = 'history-item';
                    item.innerHTML = `
                        <img src="${data.imageUrl}" class="history-img" alt="ë¶„ë¥˜ ì´ë¯¸ì§€">
                        <div class="history-info">
                            <div class="history-label">${data.label}</div>
                            <div class="history-score">ì •í™•ë„ ${(data.score * 100).toFixed(1)}%</div>
                            <div class="history-date">${new Date(data.timestamp.seconds * 1000).toLocaleString('ko-KR')}</div>
                        </div>
                    `;
                    historyList.appendChild(item);
                });
            } catch (error) {
                historyList.innerHTML = `<div class="error" style="display: block;">ê¸°ë¡ ë¡œë“œ ì‹¤íŒ¨: ${error.message}</div>`;
            }
        }
        
        // í†µê³„ ë¡œë“œ
        async function loadStats() {
            if (!currentUser) return;
            
            statsContent.innerHTML = '<div class="spinner" style="display: block;"></div>';
            
            try {
                const q = query(
                    collection(db, 'classifications'),
                    where('userId', '==', currentUser.uid)
                );
                
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    statsContent.innerHTML = '<div class="no-history">í†µê³„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
                    return;
                }
                
                // í†µê³„ ë°ì´í„° ìˆ˜ì§‘
                const stats = {};
                let totalCount = 0;
                let totalScore = 0;
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    totalCount++;
                    totalScore += data.score;
                    
                    if (stats[data.label]) {
                        stats[data.label]++;
                    } else {
                        stats[data.label] = 1;
                    }
                });
                
                // í†µê³„ ì •ë ¬ (ë§ì´ ë¶„ë¥˜í•œ ìˆœ)
                const sortedStats = Object.entries(stats).sort((a, b) => b[1] - a[1]);
                
                // í†µê³„ HTML ìƒì„±
                let statsHTML = `
                    <div style="background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%); padding: 30px; border-radius: 16px; margin-bottom: 25px; border: 2px solid #e2e8f0;">
                        <h2 style="color: #1a202c; margin-bottom: 20px; font-size: 1.8em;">ğŸ“Š ë‚˜ì˜ ë¶„ë¥˜ í†µê³„</h2>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px;">
                            <div style="background: white; padding: 20px; border-radius: 12px; text-align: center;">
                                <div style="font-size: 2.5em; font-weight: 800; color: #667eea;">${totalCount}</div>
                                <div style="color: #718096; margin-top: 8px; font-weight: 600;">ì´ ë¶„ë¥˜ íšŸìˆ˜</div>
                            </div>
                            <div style="background: white; padding: 20px; border-radius: 12px; text-align: center;">
                                <div style="font-size: 2.5em; font-weight: 800; color: #48bb78;">${(totalScore / totalCount * 100).toFixed(1)}%</div>
                                <div style="color: #718096; margin-top: 8px; font-weight: 600;">í‰ê·  ì •í™•ë„</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: white; padding: 30px; border-radius: 16px; border: 2px solid #e2e8f0;">
                        <h3 style="color: #1a202c; margin-bottom: 20px; font-size: 1.4em;">ğŸ† ë¶„ë¥˜ ìˆœìœ„</h3>
                `;
                
                sortedStats.forEach(([label, count], index) => {
                    const percentage = (count / totalCount * 100).toFixed(1);
                    const medal = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : 'ğŸ“Œ';
                    
                    statsHTML += `
                        <div style="margin-bottom: 15px; padding: 15px; background: linear-gradient(135deg, #ffffff 0%, #f7fafc 100%); border-radius: 12px; border-left: 4px solid #667eea;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <span style="font-size: 1.5em;">${medal}</span>
                                    <span style="font-weight: 700; font-size: 1.2em; color: #2d3748;">${label}</span>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 1.4em; font-weight: 800; color: #667eea;">${count}íšŒ</div>
                                    <div style="font-size: 0.9em; color: #a0aec0;">${percentage}%</div>
                                </div>
                            </div>
                            <div style="margin-top: 10px; background: #e2e8f0; height: 8px; border-radius: 4px; overflow: hidden;">
                                <div style="background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); height: 100%; width: ${percentage}%; transition: width 0.5s;"></div>
                            </div>
                        </div>
                    `;
                });
                
                statsHTML += `
                    </div>
                    
                    <div style="margin-top: 25px; padding: 20px; background: linear-gradient(135deg, #e6fffa 0%, #b2f5ea 100%); border-radius: 16px; text-align: center; border: 2px solid #81e6d9;">
                        <div style="font-size: 1.1em; color: #234e52; font-weight: 600;">
                            ğŸŒ± ì§€ê¸ˆê¹Œì§€ ${totalCount}ê°œì˜ ì“°ë ˆê¸°ë¥¼ ì˜¬ë°”ë¥´ê²Œ ë¶„ë¥˜í–ˆì–´ìš”!
                        </div>
                    </div>
                `;
                
                statsContent.innerHTML = statsHTML;
            } catch (error) {
                statsContent.innerHTML = `<div class="error" style="display: block;">í†µê³„ ë¡œë“œ ì‹¤íŒ¨: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>