<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì“°ë ˆê¸° ë¶„ë¥˜ AI</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .container { background: white; border-radius: 20px; padding: 40px; max-width: 600px; width: 100%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        h1 { color: #333; margin-bottom: 30px; text-align: center; font-size: 2em; }
        
        /* ë¡œê·¸ì¸ í™”ë©´ */
        #loginScreen { text-align: center; }
        .login-btn { background: white; color: #333; border: 2px solid #ddd; padding: 15px 40px; border-radius: 25px; font-size: 16px; cursor: pointer; width: 100%; margin-top: 10px; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 10px; transition: all 0.3s; }
        .login-btn:hover { border-color: #667eea; background: #f8f9ff; }
        
        /* ì‚¬ìš©ì ì •ë³´ */
        .user-info { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; padding: 15px; background: #f8f9ff; border-radius: 10px; }
        .user-info img { width: 40px; height: 40px; border-radius: 50%; }
        .user-name { flex: 1; margin-left: 10px; font-weight: bold; color: #333; }
        .logout-btn { background: #ff4444; color: white; border: none; padding: 8px 20px; border-radius: 15px; cursor: pointer; font-size: 14px; }
        
        /* íƒ­ ë©”ë‰´ */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab { flex: 1; padding: 12px; background: #f0f0f0; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; transition: all 0.3s; }
        .tab.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        
        .upload-area { border: 3px dashed #667eea; border-radius: 15px; padding: 40px; text-align: center; cursor: pointer; transition: all 0.3s; margin-bottom: 20px; }
        .upload-area:hover { border-color: #764ba2; background: #f8f9ff; }
        .upload-area.drag-over { border-color: #764ba2; background: #f0f0ff; }
        input[type="file"] { display: none; }
        button { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 15px 40px; border-radius: 25px; font-size: 16px; cursor: pointer; width: 100%; margin-top: 10px; font-weight: bold; transition: transform 0.2s; }
        button:hover { transform: scale(1.05); }
        button:disabled { opacity: 0.6; cursor: not-allowed; transform: scale(1); }
        #preview { max-width: 100%; border-radius: 10px; margin: 20px 0; display: none; }
        #result { margin-top: 30px; padding: 20px; background: #f8f9ff; border-radius: 15px; display: none; }
        .result-label { font-size: 1.5em; color: #667eea; font-weight: bold; margin-bottom: 10px; }
        .result-score { color: #666; font-size: 1.2em; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error { background: #ffe6e6; color: #cc0000; padding: 15px; border-radius: 10px; margin-top: 20px; display: none; }
        
        /* íˆìŠ¤í† ë¦¬ */
        #historyTab { display: none; }
        .history-item { background: #f8f9ff; padding: 15px; border-radius: 10px; margin-bottom: 15px; display: flex; gap: 15px; align-items: center; }
        .history-img { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; }
        .history-info { flex: 1; }
        .history-label { font-weight: bold; color: #667eea; font-size: 1.1em; }
        .history-date { color: #999; font-size: 0.9em; margin-top: 5px; }
        .no-history { text-align: center; color: #999; padding: 40px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ—‘ï¸ ì“°ë ˆê¸° ë¶„ë¥˜ AI</h1>
        
        <!-- ë¡œê·¸ì¸ í™”ë©´ -->
        <div id="loginScreen">
            <p style="margin-bottom: 30px; color: #666;">ë¡œê·¸ì¸í•˜ì—¬ ë¶„ì„ ê¸°ë¡ì„ ì €ì¥í•˜ì„¸ìš”</p>
            <button class="login-btn" id="googleLoginBtn">
                <svg width="20" height="20" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                Googleë¡œ ë¡œê·¸ì¸
            </button>
        </div>
        
        <!-- ë©”ì¸ í™”ë©´ (ë¡œê·¸ì¸ í›„) -->
        <div id="mainScreen" style="display: none;">
            <!-- ì‚¬ìš©ì ì •ë³´ -->
            <div class="user-info">
                <img id="userPhoto" src="" alt="User">
                <span class="user-name" id="userName"></span>
                <button class="logout-btn" id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
            
            <!-- íƒ­ ë©”ë‰´ -->
            <div class="tabs">
                <button class="tab active" id="classifyTabBtn">ë¶„ë¥˜í•˜ê¸°</button>
                <button class="tab" id="historyTabBtn">ë‚´ ê¸°ë¡</button>
            </div>
            
            <!-- ë¶„ë¥˜ íƒ­ -->
            <div id="classifyTab">
                <div class="upload-area" id="uploadArea">
                    <p style="font-size: 1.2em; color: #666;">ğŸ“· ì´ë¯¸ì§€ë¥¼ í´ë¦­í•˜ê±°ë‚˜ ë“œë˜ê·¸í•˜ì—¬ ì—…ë¡œë“œ</p>
                    <input type="file" id="fileInput" accept="image/*">
                </div>
                
                <img id="preview">
                <div class="spinner" id="spinner"></div>
                
                <button id="classifyBtn" style="display: none;">ë¶„ë¥˜í•˜ê¸°</button>
                
                <div id="result">
                    <div class="result-label" id="resultLabel"></div>
                    <div class="result-score" id="resultScore"></div>
                </div>
                
                <div class="error" id="error"></div>
            </div>
            
            <!-- íˆìŠ¤í† ë¦¬ íƒ­ -->
            <div id="historyTab">
                <div id="historyList"></div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, query, where, orderBy, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

        // Firebase ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyAntkuWODPMzCr6pBK6HInee9Vrd_Dvdc0",
            authDomain: "garbage-classifier-27697.firebaseapp.com",
            projectId: "garbage-classifier-27697",
            storageBucket: "garbage-classifier-27697.firebasestorage.app",
            messagingSenderId: "1079222481108",
            appId: "1:1079222481108:web:f12b06ef3c20eae856cb41"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        const API_URL = 'https://garbage-classifier-16970477973.asia-northeast3.run.app';

        // ë¶„ë¥˜ ë¼ë²¨ í•œê¸€ ë²ˆì—­ ë° ì²˜ë¦¬ ë°©ë²•
        const wasteInfo = {
            'Battery': {
                label: 'ë°°í„°ë¦¬',
                disposal: 'ğŸ”‹ ë°°í„°ë¦¬: ì „ìš© ìˆ˜ê±°í•¨ì— ë°°ì¶œ (ì£¼ë¯¼ì„¼í„°, ëŒ€í˜•ë§ˆíŠ¸)'
            },
            'Biological': {
                label: 'ìŒì‹ë¬¼ì“°ë ˆê¸°',
                disposal: 'ğŸ¥¬ ìŒì‹ë¬¼: ë¬¼ê¸° ì œê±° í›„ ì „ìš© ìˆ˜ê±°í•¨ì— ë°°ì¶œ'
            },
            'Cardboard': {
                label: 'ê³¨íŒì§€',
                disposal: 'ğŸ“¦ ê³¨íŒì§€: í…Œì´í”„/ìƒí‘œ ì œê±° í›„ í´ì„œ ë°°ì¶œ'
            },
            'Clothes': {
                label: 'ì˜ë¥˜',
                disposal: 'ğŸ‘• ì˜ë¥˜: ê¹¨ë—ì´ ì„¸íƒ í›„ ì˜ë¥˜ìˆ˜ê±°í•¨ ë˜ëŠ” ì¬í™œìš©ì„¼í„°'
            },
            'Glass': {
                label: 'ìœ ë¦¬',
                disposal: 'ğŸ¾ ìœ ë¦¬ë³‘: ë‚´ìš©ë¬¼ ë¹„ìš°ê³  ëšœê»‘ ë¶„ë¦¬ í›„ ë°°ì¶œ'
            },
            'Metal': {
                label: 'ê¸ˆì†',
                disposal: 'ğŸ¥« ìº”ë¥˜: ë‚´ìš©ë¬¼ ì œê±° í›„ ì••ì°©í•˜ì—¬ ë°°ì¶œ'
            },
            'Paper': {
                label: 'ì¢…ì´',
                disposal: 'ğŸ“„ ì¢…ì´ë¥˜: ë¹„ë‹/ì² ì‹¬ ì œê±° í›„ ë°°ì¶œ'
            },
            'Plastic': {
                label: 'í”Œë¼ìŠ¤í‹±',
                disposal: 'â™»ï¸ í”Œë¼ìŠ¤í‹±: ë¼ë²¨ ì œê±°, ê¹¨ë—ì´ ì”»ì–´ì„œ ë°°ì¶œ'
            },
            'Shoes': {
                label: 'ì‹ ë°œ',
                disposal: 'ğŸ‘Ÿ ì‹ ë°œ: ì¬í™œìš©ì„¼í„° ë˜ëŠ” ì˜ë¥˜ìˆ˜ê±°í•¨ì— ë°°ì¶œ'
            },
            'Trash': {
                label: 'ì¼ë°˜ì“°ë ˆê¸°',
                disposal: 'ğŸ—‘ï¸ ì¼ë°˜ì“°ë ˆê¸°: ì¢…ëŸ‰ì œë´‰íˆ¬ì— ë°°ì¶œ'
            }
        };

        // DOM ìš”ì†Œ
        const loginScreen = document.getElementById('loginScreen');
        const mainScreen = document.getElementById('mainScreen');
        const googleLoginBtn = document.getElementById('googleLoginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const userName = document.getElementById('userName');
        const userPhoto = document.getElementById('userPhoto');
        
        const classifyTabBtn = document.getElementById('classifyTabBtn');
        const historyTabBtn = document.getElementById('historyTabBtn');
        const classifyTab = document.getElementById('classifyTab');
        const historyTab = document.getElementById('historyTab');
        
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const preview = document.getElementById('preview');
        const classifyBtn = document.getElementById('classifyBtn');
        const result = document.getElementById('result');
        const resultLabel = document.getElementById('resultLabel');
        const resultScore = document.getElementById('resultScore');
        const spinner = document.getElementById('spinner');
        const errorDiv = document.getElementById('error');
        const historyList = document.getElementById('historyList');

        let selectedFile = null;
        let currentUser = null;

        // ë¡œê·¸ì¸ ìƒíƒœ ê°ì§€
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                userName.textContent = user.displayName;
                userPhoto.src = user.photoURL;
                loginScreen.style.display = 'none';
                mainScreen.style.display = 'block';
                loadHistory();
            } else {
                currentUser = null;
                loginScreen.style.display = 'block';
                mainScreen.style.display = 'none';
            }
        });

        // Google ë¡œê·¸ì¸
        googleLoginBtn.addEventListener('click', async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                alert('ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + error.message);
            }
        });

        // ë¡œê·¸ì•„ì›ƒ
        logoutBtn.addEventListener('click', () => {
            signOut(auth);
        });

        // íƒ­ ì „í™˜
        classifyTabBtn.addEventListener('click', () => {
            classifyTabBtn.classList.add('active');
            historyTabBtn.classList.remove('active');
            classifyTab.style.display = 'block';
            historyTab.style.display = 'none';
        });

        historyTabBtn.addEventListener('click', () => {
            historyTabBtn.classList.add('active');
            classifyTabBtn.classList.remove('active');
            historyTab.style.display = 'block';
            classifyTab.style.display = 'none';
            loadHistory();
        });

        // íŒŒì¼ ì—…ë¡œë“œ
        uploadArea.addEventListener('click', () => fileInput.click());
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('drag-over');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('drag-over');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                handleFile(file);
            }
        });
        
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) handleFile(file);
        });
        
        function handleFile(file) {
            selectedFile = file;
            const reader = new FileReader();
            reader.onload = (e) => {
                preview.src = e.target.result;
                preview.style.display = 'block';
                classifyBtn.style.display = 'block';
                result.style.display = 'none';
                errorDiv.style.display = 'none';
            };
            reader.readAsDataURL(file);
        }
        
        // ë¶„ë¥˜í•˜ê¸°
        classifyBtn.addEventListener('click', async () => {
            if (!selectedFile || !currentUser) return;
            
            classifyBtn.disabled = true;
            spinner.style.display = 'block';
            result.style.display = 'none';
            errorDiv.style.display = 'none';
            
            const formData = new FormData();
            formData.append('file', selectedFile);
            
            try {
                // AI ë¶„ë¥˜ ì‹¤í–‰
                const response = await fetch(`${API_URL}/predict`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    // ë¼ë²¨ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                    const labelInfo = wasteInfo[data.prediction.label] || {
                        label: data.prediction.label,
                        disposal: 'ë¶„ë¥˜ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.'
                    };
                    
                    // ê²°ê³¼ í‘œì‹œ
                    resultLabel.textContent = `ë¶„ë¥˜ ê²°ê³¼: ${labelInfo.label}`;
                    resultScore.textContent = `ì‹ ë¢°ë„: ${(data.prediction.score * 100).toFixed(2)}%`;
                    
                    // ì²˜ë¦¬ ë°©ë²• ì¶”ê°€
                    const disposalInfo = document.createElement('div');
                    disposalInfo.style.cssText = 'margin-top: 15px; padding: 15px; background: #e8f5e9; border-radius: 10px; color: #2e7d32; font-weight: bold;';
                    disposalInfo.textContent = labelInfo.disposal;
                    result.innerHTML = '';
                    result.appendChild(document.createTextNode(`ë¶„ë¥˜ ê²°ê³¼: ${labelInfo.label}`));
                    result.appendChild(document.createElement('br'));
                    const scoreSpan = document.createElement('span');
                    scoreSpan.className = 'result-score';
                    scoreSpan.textContent = `ì‹ ë¢°ë„: ${(data.prediction.score * 100).toFixed(2)}%`;
                    result.appendChild(scoreSpan);
                    result.appendChild(disposalInfo);
                    result.style.display = 'block';
                    
                    // Firebase Storageì— ì´ë¯¸ì§€ ì—…ë¡œë“œ
                    const timestamp = Date.now();
                    const imageRef = ref(storage, `images/${currentUser.uid}/${timestamp}_${selectedFile.name}`);
                    await uploadBytes(imageRef, selectedFile);
                    const imageUrl = await getDownloadURL(imageRef);
                    
                    // Firestoreì— ë¶„ì„ ê²°ê³¼ ì €ì¥
                    const docData = {
                        userId: currentUser.uid,
                        userName: currentUser.displayName,
                        imageUrl: imageUrl,
                        label: labelInfo.label,  // í•œê¸€ ë¼ë²¨ ì €ì¥
                        labelEn: data.prediction.label,  // ì˜ì–´ ë¼ë²¨ë„ ì €ì¥
                        score: data.prediction.score,
                        timestamp: new Date()
                    };
                    
                    // inferenceTimeì´ ìˆìœ¼ë©´ ì¶”ê°€
                    if (data.inference_time_ms !== undefined) {
                        docData.inferenceTime = data.inference_time_ms;
                    }
                    
                    await addDoc(collection(db, 'classifications'), docData);
                    
                    alert('ë¶„ì„ ê²°ê³¼ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
                } else {
                    throw new Error(data.detail || 'ë¶„ë¥˜ ì‹¤íŒ¨');
                }
            } catch (error) {
                errorDiv.textContent = `ì˜¤ë¥˜: ${error.message}`;
                errorDiv.style.display = 'block';
            } finally {
                spinner.style.display = 'none';
                classifyBtn.disabled = false;
            }
        });

        // íˆìŠ¤í† ë¦¬ ë¡œë“œ
        async function loadHistory() {
            if (!currentUser) return;
            
            historyList.innerHTML = '<div class="spinner" style="display: block;"></div>';
            
            try {
                const q = query(
                    collection(db, 'classifications'),
                    where('userId', '==', currentUser.uid),
                    orderBy('timestamp', 'desc')
                );
                
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    historyList.innerHTML = '<div class="no-history">ë¶„ì„ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                    return;
                }
                
                historyList.innerHTML = '';
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const item = document.createElement('div');
                    item.className = 'history-item';
                    item.innerHTML = `
                        <img src="${data.imageUrl}" class="history-img" alt="ì´ë¯¸ì§€">
                        <div class="history-info">
                            <div class="history-label">${data.label}</div>
                            <div class="result-score">ì‹ ë¢°ë„: ${(data.score * 100).toFixed(2)}%</div>
                            <div class="history-date">${new Date(data.timestamp.seconds * 1000).toLocaleString('ko-KR')}</div>
                        </div>
                    `;
                    historyList.appendChild(item);
                });
            } catch (error) {
                historyList.innerHTML = `<div class="error" style="display: block;">ê¸°ë¡ ë¡œë“œ ì‹¤íŒ¨: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>